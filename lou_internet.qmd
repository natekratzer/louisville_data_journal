---
title: "Internet in Louisville"
format: html
---

Load libraries
```{r}
library(tidyverse)
library(tidycensus)
```

Download data using tidycensus to work with Census API
```{r}
api_key <- readLines("census_api_key.txt", n = 1)
census_api_key(api_key, install = TRUE)
```


Start by searching for variables related to internet access
```{r}
var_list <- load_variables(2024, dataset = "acs5")

int_list <- var_list |>  
    filter(str_detect(concept, "Internet"))
```

Found 4 to focus on:
B28002_004 is an estimate of people with a broadband subscription of any type
B28002_006 is an estimtate of people with only a cellular plan, need to subtract this from total
B28003_002 is an estimate of people with a computer
B28003_004 is an estimate of people with both a broadband subscription and a computer

And then we want to get the _001 from each table to calculate percentages

Documentation for [B28002](https://data.census.gov/table/ACSDT5Y2024.B28002?q=B28002) is here

Pull tract level data
```{r}
acs_data <- get_acs(
    state = "KY", 
    county = "Jefferson", 
    geography = "tract", 
    variables = c("B28002_001", "B28002_004", "B28002_006", "B28003_001", "B28003_002", "B20003_004"), 
    geometry = TRUE, 
    year = 2024
    )
```

Prep data for visualization
```{r}
map_data <- acs_data |>
    filter(GEOID != "21111980100") |> #can exclude airport if desired
    pivot_wider(names_from = variable, values_from = c(estimate, moe))|>
    mutate(internet_access_percent = round(100 * (estimate_B28002_004 - estimate_B28002_006) / estimate_B28002_001, 2))
```
lous

Create the map
```{r}
map_data |> 
    ggplot(aes(fill = internet_access_percent)) + 
    geom_sf(color = NA) + 
    scale_fill_viridis_c() +
    labs(title = "Broadband Internet Access in Louisville", 
    subtitle = "Excluding Cell Phone Only Access",
    caption = "Louisville Data Journal analysis using ACS B28002 2024 5yr data",
    fill = "Percent") +
    theme_void(base_size = 18) +
    theme(legend.position = "right")

```

Write out a GeoJSON file that can be uploaded to Datawrapper
```{r}
sf::st_write(
    map_data, 
    dsn = "lou_internet24_update.geojson", 
    driver ="GeoJSON"
    )
```

Write a .csv file for google sheets upload
```{r}
map_data |>
    select(GEOID, Name = NAME, Internet_Access = internet_access_percent) |>
    write_csv("lou_internet24_update.csv")
```

## Longitudinal Data

Get yearly data for Louisville
- No 2020 ACS, so must exclude from API call loop
- Data changed dramatically in 2016, would need to crosswalk for earlier years, so I just started at 2016 rather than trying to translate 2013-2015 data. 
```{r}
years <- list(c(2013:2019,2021:2024))

get_yearly_data <- function(year_to_get) {
    acs_data <- get_acs(
    state = "KY", 
    county = "Jefferson", 
    geography = "county", 
    variables = c("B28002_001", "B28002_004", "B28002_006", "B28003_001", "B28003_002", "B20003_004"), 
    year = year_to_get,
    survey = "acs1"
    )

    acs_data$year <- year_to_get

    return(acs_data)
}

lou_data <- pmap(years, get_yearly_data) |>
    bind_rows()
```

Prep for graphing
```{r}
lou_data <- lou_data |> 
    pivot_wider(names_from = variable, values_from = c(estimate, moe)) |>
    mutate(internet_access_percent = round(100 * (estimate_B28002_004 - estimate_B28002_006) / estimate_B28002_001, 2))
```

### calculate margin or error

(Census Documentation)[https://www.census.gov/content/dam/Census/library/publications/2020/acs/acs_general_handbook_2020_ch08.pdf] on approximating margin of error is quite useful, I just translated the formulas provided there into code. 

```{r}
lou_data <- lou_data |>
    mutate(excl_cell = estimate_B28002_004 - estimate_B28002_006,
           moe_excl_cell = sqrt(moe_B28002_004^2 + moe_B28002_004^2),
           moe_percent = 100 * (1/estimate_B28002_001) * sqrt(moe_excl_cell^2 - internet_access_percent^2 * moe_B28002_001)
    )
```

Map Louisville only
```{r}
# It seems clear there's huge data change in 2016, possibly to the point that the variable names meant other things before then. 
lou_data <- lou_data |>
    filter(year > 2015) 

ggplot(lou_data, aes(x = year, y = internet_access_percent)) + 
    geom_point(color = "blue") +
    geom_errorbar(aes(ymax = internet_access_percent + moe_percent,      
                      ymin = internet_access_percent - moe_percent,
                      width = 0.5,
                      
       ),
       color = "blue") + 
    geom_line(color = "blue", linetype = "dashed") +
    scale_x_continuous(breaks = seq(2016, 2024, 2)) +
    labs(title = "Internet Access In Louisville",
         subtitle = "",
         caption = "Louisville Data Journal, ACS B28002. Data not available for 2020.",
         y = "Percent",
         x = "Year") +
    theme_classic()
```

Write out .csv for upload
```{r}
graph_data |> write_csv("int_over_time.csv")
```

## U.S. Data as a comparison point 
```{r}
years <- list(c(2016:2019,2021:2024))

get_yearly_data <- function(year_to_get) {
    acs_data <- get_acs(
    geography = "us", 
    variables = c("B28002_001", "B28002_004", "B28002_006", "B28003_001", "B28003_002", "B20003_004"), 
    year = year_to_get,
    survey = "acs1"
    )

    acs_data$year <- year_to_get

    return(acs_data)
}

us_data <- pmap(years, get_yearly_data) |>
    bind_rows()
```

```{r}
us_data <- us_data |> 
    pivot_wider(names_from = variable, values_from = c(estimate, moe)) |>
    mutate(internet_access_percent = round(100 * (estimate_B28002_004 - estimate_B28002_006) / estimate_B28002_001, 2),
           excl_cell = estimate_B28002_004 - estimate_B28002_006,
           moe_excl_cell = sqrt(moe_B28002_004^2 + moe_B28002_004^2),
           moe_percent = 100 * (1/estimate_B28002_001) * sqrt(moe_excl_cell^2 - internet_access_percent^2 * moe_B28002_001)     
    )
```

Can bind_rows because they are identical and I want long format rather than wide for graphing anyway. 
```{r}
joined_data <- bind_rows(us_data, lou_data) |>
    mutate(display_name = case_when(
        NAME == "Jefferson County, Kentucky" ~ "Louisville",
        NAME == "United States" ~ "U.S.",
        TRUE ~ "Other"
    )) |>
    select(display_name, year, internet_access_percent, moe_percent)
```

Plot U.S. and Louisville over time
```{r}
ggplot(joined_data, aes(x = year, y = internet_access_percent, color = display_name)) + 
    geom_point() +
    geom_errorbar(aes(ymax = internet_access_percent + moe_percent,      
                      ymin = internet_access_percent - moe_percent,
                      width = 0.5,
                      color = display_name             
       )) + 
    geom_line(linetype = "dashed") +
    scale_x_continuous(breaks = seq(2016, 2024, 2)) +
    labs(title = "Louisville and U.S. home broadband internet",
         subtitle = "Louisville's jump in 2020 mirrors the U.S. Trend",
         caption = "Louisville Data Journal, ACS B28002. Data not available for 2020.",
         y = "Percent",
         x = "Year",
         color = "Geography") +
    theme_classic(base_size = 16)
```

Write out for Datawrapper graphic
```{r}
out_data <- joined_data |> 
    select(-moe_percent) |>
    pivot_wider(names_from = display_name, values_from = internet_access_percent) |>
    write_csv("lou_and_us_internet.csv")
```